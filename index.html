<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Pro Workout</title>
    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #1c1c1e;
            --primary: #0A84FF;
            --danger: #FF453A;
            --success: #30d158;
            --text-main: #ffffff;
            --text-sub: #98989d;
            --border: #38383a;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            padding-top: 50px;
            padding-bottom: 100px;
        }
        
        /* Layout & Typography */
        h1, h2, h3 { margin: 0; font-weight: 700; }
        h1 { font-size: 28px; margin-bottom: 20px; }
        .view { display: none; }
        .view.active { display: block; }
        .row { display: flex; gap: 8px; align-items: center; }
        
        /* Buttons */
        .btn {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: opacity 0.2s;
        }
        .btn:active { opacity: 0.7; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: black; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-sub); }
        .btn-small { width: auto; padding: 6px 12px; font-size: 13px; margin: 0; }

        /* Form Elements */
        .input-card {
            background: var(--card-bg);
            padding: 16px;
            border-radius: 14px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }
        input, textarea {
            background: #2c2c2e;
            border: 1px solid #3a3a3c;
            color: white;
            border-radius: 8px;
            padding: 10px;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
        }
        input:focus { outline: 2px solid var(--primary); border-color: transparent; }
        label { font-size: 12px; color: var(--text-sub); display: block; margin-bottom: 4px; margin-top: 8px; }

        /* Active Session List */
        .set-row {
            background: var(--card-bg);
            margin-bottom: 10px;
            padding: 12px;
            border-radius: 10px;
            position: relative;
        }
        .set-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: var(--primary);
            font-weight: 600;
        }
        .set-inputs { display: grid; grid-template-columns: 1fr 1fr 2fr; gap: 8px; }
        .mini-input { padding: 8px; font-size: 14px; text-align: center; }

        /* History Cards */
        .history-card {
            background: var(--card-bg);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .history-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .history-meta { color: var(--text-sub); font-size: 13px; margin-top: 4px; }
        .history-actions { display: flex; gap: 8px; }
        
        /* Updated Summary Styles */
        .history-summary { font-size: 14px; line-height: 1.5; }
        .summary-line { 
            display: flex; 
            justify-content: space-between; 
            padding: 6px 0; 
            border-bottom: 1px solid #2c2c2e;
            align-items: flex-start;
        }
        .summary-line:last-child { border-bottom: none; }
        .ex-name { font-weight: 600; width: 35%; color: #e1e1e1; }
        .ex-sets { width: 65%; text-align: right; color: var(--text-sub); font-size: 13px; }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 20px;
            background: var(--primary);
            color: white;
            width: 56px;
            height: 56px;
            border-radius: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            border: none;
            cursor: pointer;
            z-index: 100;
        }
    </style>
</head>
<body>

    <div id="dashboard-view" class="view active">
        <h1>My Workouts</h1>
        <div id="history-list"></div>
        <button class="fab" onclick="createNewWorkout()">+</button>
    </div>

    <div id="editor-view" class="view">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <button class="btn btn-outline btn-small" onclick="closeEditor()">Back</button>
            <h2 style="margin:0; font-size: 18px;" id="editor-title">New Workout</h2>
            <button class="btn btn-success btn-small" onclick="saveWorkout()">Finish</button>
        </div>

        <input type="text" id="workout-name" placeholder="Workout Name (e.g. Pull Day)" style="margin-bottom: 20px; font-size: 18px; font-weight: bold;">

        <div class="input-card">
            <h3 style="margin-bottom: 10px; font-size: 16px;">Add Exercise</h3>
            
            <label>Exercise Name</label>
            <input type="text" id="new-ex-name" placeholder="e.g. Bench Press">
            
            <div class="row">
                <div style="flex:1">
                    <label>Weight (kg)</label>
                    <input type="number" id="new-ex-weight" placeholder="0">
                </div>
                <div style="flex:1">
                    <label>Reps</label>
                    <input type="number" id="new-ex-reps" placeholder="0">
                </div>
                <div style="flex:1">
                    <label>Sets</label>
                    <input type="number" id="new-ex-sets" value="1">
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="addSetsBatch()">Add to Workout</button>
        </div>

        <h3 style="margin-bottom: 10px; font-size: 16px; color: var(--text-sub);">Current Session</h3>
        <div id="active-list"></div>
        
        <br>
        <button class="btn btn-danger" onclick="deleteCurrentDraft()">Discard Workout</button>
    </div>

    <script>
        // --- STATE MANAGEMENT ---
        let workouts = JSON.parse(localStorage.getItem('workouts_db')) || [];
        let currentDraft = JSON.parse(localStorage.getItem('current_draft')) || null;

        // DOM Elements
        const dashboardView = document.getElementById('dashboard-view');
        const editorView = document.getElementById('editor-view');
        const activeListEl = document.getElementById('active-list');
        const historyListEl = document.getElementById('history-list');

        // Initial Load
        if (currentDraft) {
            openEditor(true); // Resume draft if exists
        } else {
            renderHistory();
        }

        // --- NAVIGATION ---
        function createNewWorkout() {
            // Start fresh
            currentDraft = {
                id: Date.now(),
                isNew: true,
                name: '',
                sets: []
            };
            saveDraft();
            openEditor(false);
        }

        function openEditor(isResume) {
            dashboardView.classList.remove('active');
            editorView.classList.add('active');
            
            document.getElementById('workout-name').value = currentDraft.name;
            document.getElementById('editor-title').innerText = currentDraft.isNew ? "New Workout" : "Editing Workout";
            
            // Clear Adder Inputs
            document.getElementById('new-ex-name').value = '';
            document.getElementById('new-ex-weight').value = '';
            document.getElementById('new-ex-reps').value = '';
            document.getElementById('new-ex-sets').value = '1';

            renderActiveList();
        }

        function closeEditor() {
            if (confirm("Save changes to draft and go back?")) {
                updateDraftFromUI();
                dashboardView.classList.add('active');
                editorView.classList.remove('active');
                renderHistory();
            }
        }

        // --- CORE LOGIC ---

        function addSetsBatch() {
            const name = document.getElementById('new-ex-name').value;
            const weight = document.getElementById('new-ex-weight').value;
            const reps = document.getElementById('new-ex-reps').value;
            const setsCount = parseInt(document.getElementById('new-ex-sets').value) || 1;

            if (!name) { alert("Enter an exercise name"); return; }

            for (let i = 0; i < setsCount; i++) {
                currentDraft.sets.push({
                    id: Date.now() + i, 
                    exercise: name,
                    weight: weight,
                    reps: reps,
                    notes: ''
                });
            }

            document.getElementById('new-ex-weight').value = '';
            document.getElementById('new-ex-reps').value = '';
            
            saveDraft();
            renderActiveList();
        }

        function renderActiveList() {
            activeListEl.innerHTML = '';
            
            currentDraft.sets.forEach((set, index) => {
                const div = document.createElement('div');
                div.className = 'set-row';
                div.innerHTML = `
                    <div class="set-header">
                        <span>${set.exercise} <small style="color:var(--text-sub)">#${index + 1}</small></span>
                        <span onclick="removeSet(${index})" style="color:var(--danger); cursor:pointer;">âœ•</span>
                    </div>
                    <div class="set-inputs">
                        <input type="number" class="mini-input" value="${set.weight}" placeholder="kg" oninput="updateSet(${index}, 'weight', this.value)">
                        <input type="number" class="mini-input" value="${set.reps}" placeholder="reps" oninput="updateSet(${index}, 'reps', this.value)">
                        <input type="text" class="mini-input" value="${set.notes}" placeholder="Notes..." oninput="updateSet(${index}, 'notes', this.value)">
                    </div>
                `;
                activeListEl.appendChild(div);
            });
        }

        window.updateSet = function(index, field, value) {
            currentDraft.sets[index][field] = value;
            saveDraft(); 
        };

        window.updateDraftFromUI = function() {
            currentDraft.name = document.getElementById('workout-name').value;
            saveDraft();
        }
        
        document.getElementById('workout-name').addEventListener('input', updateDraftFromUI);

        function removeSet(index) {
            currentDraft.sets.splice(index, 1);
            saveDraft();
            renderActiveList();
        }

        function saveDraft() {
            localStorage.setItem('current_draft', JSON.stringify(currentDraft));
        }

        function deleteCurrentDraft() {
            if(confirm("Discard everything?")) {
                localStorage.removeItem('current_draft');
                currentDraft = null;
                location.reload(); 
            }
        }

        function saveWorkout() {
            updateDraftFromUI();
            if (currentDraft.sets.length === 0) { alert("Workout is empty!"); return; }

            const finalName = currentDraft.name || "Untitled Workout";
            const finalDate = new Date().toLocaleDateString();

            const record = {
                id: currentDraft.isNew ? Date.now() : currentDraft.id,
                date: currentDraft.originalDate || finalDate, 
                name: finalName,
                sets: currentDraft.sets
            };

            if (currentDraft.isNew) {
                workouts.unshift(record);
            } else {
                const index = workouts.findIndex(w => w.id === currentDraft.id);
                if (index !== -1) workouts[index] = record;
            }

            localStorage.setItem('workouts_db', JSON.stringify(workouts));
            localStorage.removeItem('current_draft');
            currentDraft = null;
            
            dashboardView.classList.add('active');
            editorView.classList.remove('active');
            renderHistory();
        }

        // --- HISTORY LOGIC (UPDATED) ---

        function renderHistory() {
            historyListEl.innerHTML = '';
            workouts.forEach(w => {
                const totalSets = w.sets.length;
                
                // Group sets by exercise name
                const groups = {};
                w.sets.forEach(s => {
                    if(!groups[s.exercise]) groups[s.exercise] = [];
                    // Format: "50kg x 12"
                    groups[s.exercise].push(`${s.weight}kg x ${s.reps}`);
                });

                // Create the summary HTML
                const summaryHtml = Object.entries(groups).map(([name, setStrings]) => {
                    return `
                        <div class="summary-line">
                            <span class="ex-name">${name}</span>
                            <span class="ex-sets">${setStrings.join(', ')}</span>
                        </div>
                    `;
                }).join('');

                const div = document.createElement('div');
                div.className = 'history-card';
                div.innerHTML = `
                    <div class="history-header">
                        <div>
                            <div style="font-weight:bold; font-size:18px;">${w.name}</div>
                            <div class="history-meta">${w.date} â€¢ ${totalSets} Sets</div>
                        </div>
                        <div class="history-actions">
                            <button class="btn btn-outline btn-small" onclick="editHistoryItem(${w.id})">Edit</button>
                            <button class="btn btn-danger btn-small" style="width:30px; padding:6px 0;" onclick="deleteHistoryItem(${w.id})">ðŸ—‘</button>
                        </div>
                    </div>
                    <div class="history-summary">
                        ${summaryHtml}
                    </div>
                `;
                historyListEl.appendChild(div);
            });
        }

        window.editHistoryItem = function(id) {
            const workoutToEdit = workouts.find(w => w.id === id);
            if (!workoutToEdit) return;

            currentDraft = {
                id: workoutToEdit.id,
                isNew: false,
                originalDate: workoutToEdit.date,
                name: workoutToEdit.name,
                sets: JSON.parse(JSON.stringify(workoutToEdit.sets))
            };
            saveDraft();
            openEditor(true);
        };

        window.deleteHistoryItem = function(id) {
            if (confirm("Delete this workout log permanently?")) {
                workouts = workouts.filter(w => w.id !== id);
                localStorage.setItem('workouts_db', JSON.stringify(workouts));
                renderHistory();
            }
        };
    </script>
</body>
</html>